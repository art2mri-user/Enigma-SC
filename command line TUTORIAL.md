## Command Line Tutorial

### Use this alternative only if you cannot install the GUI for some reason

To visualize the MENU, open a terminal inside of the **Enigma-SC** folder and type: `./nographmode.sh` 

!["nographmode MENU"](img/command1.png)  

The user should follow the numeric sequence of the numbers in green **(1 - 2 - 3 - 5 - 7 - 8)**. The numbers in yellow (4 and 6) only must be triggered in special ocasions (number 4 and 6 only for those images which failed on step number 3 and 5) and number 9 (to open this tutorial page).  


### 1. Prepare Folders  

Before typing this option, the user should create an **output** folder (you can choose any name, without spaces) where all the files generated on the following steps will be placed in. The **input** folder must have all the .nii.gz files you want to process (only the .nii.gz files) and they will be selected automatically. Your **input** folder can be also a BIDS dataset (all the anatomical data name must end with T1w.nii.gz, for example: sub-01_T1w.nii.gz or sub-02_T1w.nii.gz)  

After type 1 on the terminal, the user will be asked to choose the input files option (.nii.gz or BIDS). After the choice, the path of the **output** folder will be asked, and the entire path must be given, for example: **/home/art2mri/Documents/output** If you don't know how to find the path, open a terminal inside of the output folder and type **pwd** After that, the input folder path will be asked, type the entire path, for example: **/home/art2mri/Documents/input** 

<p align="center">
  <img src="/img/command2.png" />
</p> 

After that, the folders will be prepared and once it is finished you will see a report of the selected files. The output folder will be now your **PREPARED FOLDER**.  

<p align="center">
  <img src="/img/command3.png" />
</p>  

### 2. Spinal Cord Segmentation  

By typing this option, the **Enigma-SC** will run automatically the `sct_deepseg` function of the [Spinal Cord Toolbox](https://spinalcordtoolbox.com/user_section/command-line.html) over each image you selected on the previous step. 

The user can choose between **Docker** and **Singularity/Apptainer** container platforms. After that, the path of the **PREPARED FOLDER** will be asked, give the entire path. If **Singularity/Apptainer** was the choice, before the prepared folder, the path of the **Enigma-SC** will be asked; give the entire path, for example: **/home/art2mri/Documents/Enigma-SC** 

<p align="center">
  <img src="/img/command4.png" />
</p>  

Once the process is finished, a report will be generated in the terminal informing whether it was successful for each selected file. This report will also be saved in a .txt file within the **PREPARED FOLDER**.  

## 3 and 4. Spinal Cord Segmentation  

The **Vertebral Labeling** can be performed in two ways, either by the **Automated** option or by the **Manual** option. We strongly recommend running the **Automated** button and using the **Manual** button only for those images that show misidentification of the spinal cord levels in the masks generated by the **Automated** vertebral labeling.  

The **Automated** method will predict a segmentation mask for each .nii.gz file, using a [nnunetv2](https://github.com/MIC-DKFZ/nnUNet) model trained from our pipeline according to this [paper](). After that, a seg_labeled.nii.gz file will be created and placed inside of the corresponding folder of each individual inside of the **PREPARED FOLDER**. 

For this step, it is beneficial to run the predictions using GPU, because it will significantly accelerate the the segmentation mask generation process. A GPU (graphics processing unit) is a processor made up of many cores. By working together, the cores can process data faster than a CPU (central processing unit), due to parallel execution of tasks. If you don't have a GPU, the procedure will take longer to complete but can still be done using the CPU. Initially, the [nnunetv2](https://github.com/MIC-DKFZ/nnUNet) model predictions will automatically attempt to perform this task using the GPU. If your GPU is not available for this step, a brief notification will appear everytime a new prediction starts (for each individual you have selected) , and it will automatically switch to the CPU. To check if your GPU has been correctly installed, please check [Installation Instructions](/Installation%20Instructions.md). If you are having GPU related problems, please check [here](/GPU%20related%20problems.md) how to fix it. Also note that GPU used on a shared cluster is generally controlled by a server administrator, so if you are not sure about the presence of a GPU and how to use it, please reach out to your server administrator.  

!["fig11"](/img/fig11.png)  

If you choose to run the **Manual** method, for each incorrect segmentation generated by the **Automated** method, you must create a folder (any name) and copy all the folders from the PREPARED FOLDER, which belongs to the individuals which presented misidentification on the Automated step and give the path of this folder when the PREPARED FOLDER is asked. After that, simply type the number 4 **Manual** option, and then the [Manual Labeling](https://spinalcordtoolbox.com/user_section/tutorials/registration-to-template/vertebral-labeling/manual-labeling-c2c3.html) method of the Spinal Cord Toolbox will start. You will be asked to manually select the location of the C2 and C3 vertebrae (by clicking), over each individual you have selected from the **PREPARED FOLDER** folder. **To run the Manual command, you must have the Spinal Cord Tolbox installed in your computer**.   

Once the labeling process is finished, it is important to check visually if the results correspond to the anatomical landmarks. You can check an anatomical reference image to compare your results in the section [Anatomical Ground Truth](/Anatomical%20Ground%20Truth.md). The image below shows how to access the labeled file generated previously.  

!["fig12"](/img/fig12.png)  

### 5 and 6. Spinal Cord Registration   

For all the images on which you ran the **Automated** method in the previous step, you should run the **Automated Spinal Cord Registration** option. Follow the same approach if you ran the **Manual** method, but now, choosing the **Manual Spinal Cord Registration**  

In this step, the [Registration to template](https://spinalcordtoolbox.com/user_section/tutorials/registration-to-template.html) method will be automatically performed for each individual according to the Spinal Cord Toolbox method.  

### 6. Data Extraction  

The main outcome measures of this pipeline are numerical values for Cross-Sectional Area (CSA) and eccentricity, for each participant. The **Data Extraction** command takes all the individuals within the **PREPARED FOLDER** and automatically calculate the Cross Sectional Area and Eccentricity values. Additionally, other morphometric measurements will be computed based on the `sct_process_segmentation` command from the [Spinal Cord Toolbox](https://spinalcordtoolbox.com/user_section/getting-started.html) tutorial.  

Furthermore, two .csv spreadsheets will be generated within the **PREPARED FOLDER**. The first one will be named 'csa_final_table_(mm+dd+yyyy)(hh+mm+ss),' where the information within parentheses corresponds to the date and time of execution, formatted as (month-day-year)(hour-minutes-seconds). The following spreadsheet will be named 'eccentricity_table_(mm+dd+yyyy)_(hh+mm+ss),' following the same format as the previous table. 

!["step9"](/img/step-9.png)  

In both spreadsheets, you will find the names of all the individuals you selected in the 'subject' column, followed by their respective CSA and Eccentricity values (each in their own spreadsheet). In the 'csa_final_table_' spreadsheet, you will find the CSA values corresponding to each vertebral level (C1, C2, and C3), already corrected for orthogonalization with respect to the anterior-posterior (AP) and right-left (RL) angles, to correct the neck curvature, considering the average as: 

$$
CSA = \frac{{\text{{Mean (area)}} \cdot \cos(\theta_{\text{{AP}}}) + \text{{Mean (area)}} \cdot \cos(\theta_{\text{{RL}}})}}{2}
$$  

<p align="center">
  <img src="/img/fig13-1.png" />
</p>  

### 7. Pack and Send   

And finally, the **Pack and Send** button will require the user to (following the same approach as before, of choosing platforms and folders). It takes all the individuals folders within the **PREPARED FOLDER** and compress them into singles .zip file. This will include the output generated throughout the previous steps. The compressed files for each individual will be placed within the **PREPARED FOLDER** (excluding the raw .nii.gz image), and they will be ready to be sent!  

!["step10"](/img/step-10.png)




